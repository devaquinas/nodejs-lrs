request = require 'supertest'
assert = require 'assert'
Server = require '../../../app/server'
logger = require '../../../app/logger'
config = require '../../../app/config'
StatementFactory = require '../../factories/statement'

dbCounter = 0

module.exports.apiVersion = '1.0.1'

beforeEach (done) ->
  @timeout 4000
  configClone = JSON.parse JSON.stringify config
  configClone.server.port = false
  configClone.database.name = "nodejs-lrs-test-#{dbCounter++}"
  configClone.database.reset = true

  new Server configClone, (err, server) ->

    unless err
      module.exports.request = request server.getRestServer()
      dbController = server.getDBController()
      module.exports.dbController = dbController
      module.exports.factory = new StatementFactory dbController, done
    else
      logger.error err
      done err

afterEach (done) ->
  module.exports.dbController.deleteDB done
  module.exports.dbController = null
  module.exports.request = null